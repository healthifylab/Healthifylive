<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthify Lab Booking</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .header { background: #28a745; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; }
        .header img { max-width: 120px; height: auto; }
        .header nav a { color: white; margin: 0 15px; text-decoration: none; font-size: 16px; }
        .form-container { max-width: 600px; margin: 80px auto 20px; padding: 20px; background: white; border-radius: 8px; }
        .form-icon { max-width: 50px; height: auto; display: block; margin: 0 auto 10px; }
        label, input, select { display: block; width: 100%; margin: 10px 0; }
        input, select { padding: 10px; font-size: 16px; }
        button { padding: 10px; background: #28a745; color: white; border: none; cursor: pointer; font-size: 16px; }
        #confirmation { display: none; color: green; font-weight: bold; margin-top: 10px; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        table { width: 100%; font-size: 16px; }
        th, td { padding: 10px; text-align: left; }
        .whatsapp-float { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .whatsapp-float img { width: 50px; }
        .social-links { text-align: center; margin-top: 20px; }
        .social-links img { width: 30px; margin: 0 10px; }
        @media (max-width: 600px) {
            .header img { max-width: 80px; }
            .header nav a { font-size: 14px; margin: 0 10px; }
            .form-container { padding: 10px; margin-top: 60px; }
            input, select, button { font-size: 14px; }
            table, th, td { font-size: 14px; }
            .whatsapp-float img { width: 40px; }
            .form-icon { max-width: 40px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="/logo.png" alt="Healthify Lab Logo">
        <nav>
            <a href="/index.html">Home</a>
            <a href="#contact">Contact</a>
        </nav>
    </div>
    <div class="form-container">
        <img src="/booking-icon.png" alt="Booking Icon" class="form-icon">
        <h2>Book Your Test</h2>
        <form id="booking-form">
            <label>Name:</label><input type="text" name="name" required>
            <label>Age:</label><input type="number" name="age" required>
            <label>Sex:</label>
            <select name="sex" required>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
            <label>State:</label>
            <select name="state" id="state" required>
                <option value="">Select State</option>
                <!-- Populated dynamically -->
            </select>
            <label>City:</label>
            <select name="city" id="city" required>
                <option value="">Select City</option>
                <!-- Populated dynamically -->
            </select>
            <label>Pincode:</label><input type="text" name="pincode" id="pincode" required>
            <label>Address:</label><input type="text" name="address" required>
            <label>Landmark:</label><input type="text" name="landmark" required>
            <label>Mobile:</label><input type="tel" name="mobile" required>
            <label>Email:</label><input type="email" name="email" required>
            <label>Appointment Date:</label><input type="date" name="appointment_date" required>
            <label>Appointment Time:</label><input type="time" name="appointment_time" required>
            <label>Tests:</label>
            <select multiple name="tests" id="test-dropdown"></select>
            <label>Profiles:</label>
            <select multiple name="profiles" id="profile-dropdown"></select>
            <button type="submit" onclick="submitBooking()">Book Now</button>
        </form>
        <div id="confirmation"></div>
    </div>
    <div class="container">
        <h2>Test Catalog</h2>
        <table id="testCatalog" class="display">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th>Category</th>
                    <th>Sample Type</th>
                    <th>MRP (Rs.)</th>
                    <th>Description/Parameters</th>
                </tr>
            </thead>
            <tbody id="testTableBody"></tbody>
        </table>
        <div class="social-links">
            <a href="https://x.com/HealthifyLab"><img src="/x-icon.png" alt="X"></a>
            <a href="https://instagram.com/HealthifyLab"><img src="/instagram-icon.png" alt="Instagram"></a>
        </div>
    </div>
    <div class="whatsapp-float">
        <a href="https://wa.me/1234567890" target="_blank"><img src="/whatsapp-icon.png" alt="WhatsApp"></a>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDS-MJYzAB2EDNY7Hhy2RtdEkxflj2jI-A",
            authDomain: "https://healthify-lab.firebaseapp.com",
            projectId: "healthify-lab",
            storageBucket: "healthify-lab.firebasestorage.app",
            messagingSenderId: "297003315332",
            appId: "1:297003315332:web:49f6ed6fc61cce4a74d2d1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Initialize EmailJS
        emailjs.init("dJE_JHAoNTxxzTxiT");

        // State and city data (sample, replace with API data)
        const states = ["Maharashtra", "Delhi", "Karnataka"];
        const citiesByState = {
            Maharashtra: ["Mumbai", "Navi Mumbai", "Thane", "Pune"],
            Delhi: ["New Delhi", "Noida", "Gurgaon"],
            Karnataka: ["Bangalore", "Mysore"]
        };

        // Populate state dropdown
        const stateDropdown = document.getElementById("state");
        states.forEach(state => {
            const option = document.createElement("option");
            option.value = state;
            option.text = state;
            stateDropdown.appendChild(option);
        });

        // Update city dropdown based on state
        document.getElementById("state").addEventListener("change", function() {
            const cityDropdown = document.getElementById("city");
            cityDropdown.innerHTML = '<option value="">Select City</option>';
            const selectedState = this.value;
            if (citiesByState[selectedState]) {
                citiesByState[selectedState].forEach(city => {
                    const option = document.createElement("option");
                    option.value = city;
                    option.text = city;
                    cityDropdown.appendChild(option);
                });
            }
        });

        // Auto-fetch state/city from pincode
        document.getElementById("pincode").addEventListener("input", function() {
            const pincode = this.value;
            if (pincode.length === 6) {
                fetch(`http://api.postalpincode.in/pincode/${pincode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data[0].Status === "Success") {
                            const postOffice = data[0].PostOffice[0];
                            document.getElementById("state").value = postOffice.State;
                            const cityDropdown = document.getElementById("city");
                            cityDropdown.innerHTML = '<option value="">Select City</option>';
                            const option = document.createElement("option");
                            option.value = postOffice.District;
                            option.text = postOffice.District;
                            cityDropdown.appendChild(option);
                            cityDropdown.value = postOffice.District;
                        }
                    })
                    .catch(error => console.error("Pincode API error:", error));
            }
        });

        async function loadTests() {
            const querySnapshot = await db.collection("tests").get();
            const testDropdown = document.getElementById("test-dropdown");
            const profileDropdown = document.getElementById("profile-dropdown");
            const tableBody = document.getElementById("testTableBody");
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const option = document.createElement("option");
                option.value = data.Test_Name;
                option.text = `${data.Test_Name} - Rs. ${data.MRP}`;
                if (data.Category === "Individual Tests") {
                    testDropdown.appendChild(option);
                } else {
                    profileDropdown.appendChild(option.cloneNode(true));
                }
                const description = data.Test_Parameters_Included ? `${data.Test_Description}<br><strong>Included:</strong> ${data.Test_Parameters_Included}` : data.Test_Description;
                const row = `
                    <tr>
                        <td>${data.Test_Name}</td>
                        <td>${data.Category}</td>
                        <td>${data.Sample_Type}</td>
                        <td>${data.MRP}</td>
                        <td>${description}</td>
                    </tr>`;
                tableBody.innerHTML += row;
            });

            $("#testCatalog").DataTable({
                responsive: true,
                paging: true,
                searching: true,
                ordering: true
            });
        }
        loadTests();

        function submitBooking() {
            const form = document.getElementById("booking-form");
            if (form) {
                const formData = new FormData(form);
                const data = {
                    name: formData.get("name"),
                    age: formData.get("age"),
                    sex: formData.get("sex"),
                    state: formData.get("state"),
                    city: formData.get("city"),
                    pincode: formData.get("pincode"),
                    address: formData.get("address"),
                    landmark: formData.get("landmark"),
                    mobile: formData.get("mobile"),
                    email: formData.get("email"),
                    appointment_date: formData.get("appointment_date"),
                    appointment_time: formData.get("appointment_time"),
                    tests: formData.getAll("tests"),
                    profiles: formData.getAll("profiles")
                };

                const bookingId = `HFL${Date.now()}`;

                db.collection("bookings").doc(bookingId).set(data)
                    .then(() => {
                        emailjs.send("service_z3ac4pk", "template_5v6t6ku", {
                            ...data,
                            booking_id: bookingId,
                            tests: data.tests.join(", "),
                            profiles: data.profiles.join(", ")
                        })
                            .then(() => {
                                const confirmation = document.getElementById("confirmation");
                                confirmation.style.display = "block";
                                confirmation.textContent = `Booking successful! Your Booking ID: ${bookingId}`;

                                const { jsPDF } = window.jspdf;
                                const doc = new jsPDF();
                                doc.text("Healthify Booking Receipt", 10, 10);
                                doc.text(`Booking ID: ${bookingId}`, 10, 20);
                                doc.text(`Name: ${data.name}`, 10, 30);
                                doc.text(`Mobile: ${data.mobile}`, 10, 40);
                                doc.text(`Tests: ${data.tests.join(", ")}`, 10, 50);
                                doc.text(`Profiles: ${data.profiles.join(", ")}`, 10, 60);
                                doc.text(`Date: ${data.appointment_date}`, 10, 70);
                                doc.text(`Time: ${data.appointment_time}`, 10, 80);
                                doc.save(`Healthify_Booking_${bookingId}.pdf`);
                            })
                            .catch(error => console.error("EmailJS error:", error));
                    })
                    .catch(error => console.error("Firestore error:", error));
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const selectedTests = JSON.parse(localStorage.getItem("selectedTests") || "[]");
            if (selectedTests.length > 0) {
                const testDropdown = document.getElementById("test-dropdown");
                const profileDropdown = document.getElementById("profile-dropdown");
                selectedTests.forEach(value => {
                    if (testDropdown.querySelector(`option[value="${value}"]`)) {
                        testDropdown.querySelector(`option[value="${value}"]`).selected = true;
                    }
                    if (profileDropdown.querySelector(`option[value="${value}"]`)) {
                        profileDropdown.querySelector(`option[value="${value}"]`).selected = true;
                    }
                });
                localStorage.removeItem("selectedTests");
            }
        });
    </script>
</body>
</html>
