<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>🔐 Patient Login – Healthifylive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script type="module" src="/scripts/Firebase-auth.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="/public/logo.png" alt="Healthifylive Logo" class="logo">
      <nav>
        <a href="/index.html">Home</a>
        <a href="/booking.html">Book Test</a>
        <a href="/contact.html">Contact Us</a>
        <a href="/my-bookings.html">My Bookings</a>
      </nav>
    </div>
    <main>
      <h1>🔐 Patient Login</h1>
      <h3>Login with Mobile Number</h3>
      <div id="recaptcha-container"></div>
      <input type="tel" id="phoneInput" placeholder="+91XXXXXXXXXX" required>
      <button onclick="startOTPLogin()">📲 Send OTP</button>
      <button onclick="startOTPLogin()" style="display:none;" id="resendOTPBtn">🔄 Resend OTP</button><br><br>
      <input type="text" id="otpInput" placeholder="Enter OTP" style="display:none;">
      <button id="verifyOTPBtn" onclick="verifyOTP()" style="display:none;">✅ Verify OTP</button><br><br>
      <hr>
      <h3>OR Login via Email</h3>
      <input type="email" id="emailInput" placeholder="your@email.com">
      <button onclick="sendEmailLink()">📧 Send Login Link</button>
      <div id="loginStatus" style="margin-top: 10px;"></div>
    </main>
    <footer>
      <p>Healthifylive © 2025 | Contact: +91 9503832889 | Email: <a href="mailto:support@healthifylive.com">support@healthifylive.com</a></p>
      <div class="social-media">
        <a href="https://x.com/healthifylive" target="_blank"><i class="fab fa-x-twitter"></i></a>
        <a href="https://instagram.com/healthifylive" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://facebook.com/healthifylive" target="_blank"><i class="fab fa-facebook-f"></i></a>
      </div>
    </footer>
    <a href="https://wa.me/919503832889" class="whatsapp-float" target="_blank">
      <img src="/public/whatsapp-icon.png" alt="WhatsApp">
    </a>
  </div>
  <script type="module">
    import { sendOTP, sendEmailLink } from "/scripts/Firebase-auth.js";

    console.log("Scripts loaded, sendOTP and sendEmailLink available:", typeof sendOTP, typeof sendEmailLink);

    function startOTPLogin() {
      const phoneNumber = document.getElementById("phoneInput").value;
      const loginStatus = document.getElementById("loginStatus");
      console.log("Starting OTP for:", phoneNumber);
      if (!phoneNumber.match(/^\+91[0-9]{10}$/)) {
        loginStatus.className = "error";
        loginStatus.textContent = "❌ Invalid phone number. Use +91 followed by 10 digits.";
        return;
      }
      loginStatus.textContent = "📲 Sending OTP...";
      sendOTP(phoneNumber).then(confirmationResult => {
        window.confirmationResult = confirmationResult;
        document.getElementById("otpInput").style.display = "block";
        document.getElementById("verifyOTPBtn").style.display = "block";
        document.getElementById("resendOTPBtn").style.display = "block";
        loginStatus.className = "success";
        loginStatus.textContent = "📲 OTP sent! Check SMS (may be in spam) or use test code.";
      }).catch(error => {
        console.error("OTP error:", error);
        loginStatus.className = "error";
        loginStatus.textContent = `❌ Failed to send OTP: ${error.message}. Check test number or plan.`;
      });
    }

    function verifyOTP() {
      const code = document.getElementById("otpInput").value;
      const loginStatus = document.getElementById("loginStatus");
      console.log("Verifying OTP:", code);
      if (!window.confirmationResult) {
        loginStatus.className = "error";
        loginStatus.textContent = "❌ No OTP request found. Request a new OTP.";
        return;
      }
      window.confirmationResult.confirm(code).then(result => {
        loginStatus.className = "success";
        loginStatus.textContent = "✅ Login successful!";
        window.location.href = "/booking.html";
      }).catch(error => {
        console.error("OTP verification error:", error);
        loginStatus.className = "error";
        loginStatus.textContent = `❌ Invalid OTP: ${error.message}`;
      });
    }

    function sendEmailLink() {
      const email = document.getElementById("emailInput").value;
      const loginStatus = document.getElementById("loginStatus");
      console.log("Sending email link to:", email);
      if (!email) {
        loginStatus.className = "error";
        loginStatus.textContent = "❌ Please enter a valid email.";
        return;
      }
      loginStatus.textContent = "📧 Sending login link...";
      sendEmailLink(email).then(() => {
        loginStatus.className = "success";
        loginStatus.textContent = "📧 Login link sent! Check email (may be in spam).";
      }).catch(error => {
        console.error("Email link error:", error);
        loginStatus.className = "error";
        loginStatus.textContent = `❌ Failed to send login link: ${error.message}.`;
      });
    }
  </script>
  <script src="/scripts/Drawer.js"></script>
</body>
</html>
